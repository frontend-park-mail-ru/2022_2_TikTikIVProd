(()=>{"use strict";class e{constructor(e){this.parent=e}getParent(){return this.parent}}function t(e){const t=document.createElement("div");return void 0!==e.id&&(t.id=e.id),t.textContent=e.text||"",void 0!==e.styles&&e.styles.forEach((e=>{t.classList.add(e)})),t}function i(e){const t=document.createElement("button");return t.id=e.id||"",t.textContent=e.text||"",void 0!==e.styles&&e.styles.forEach((e=>{t.classList.add(e)})),void 0!==e.event&&t.addEventListener(e.event.eventType,(t=>{var i;null===(i=e.event)||void 0===i||i.callback(t)})),t}function s(e){const t=document.createElement("a");return t.id=e.id||"",t.textContent=e.text||"",t.href=e.href||"",void 0!==e.styles&&e.styles.forEach((e=>{""!==e&&t.classList.add(e)})),void 0!==e.event&&t.addEventListener(e.event.eventType,(t=>{var i;null===(i=e.event)||void 0===i||i.callback(t)})),t}function r(e){const t=document.createElement("input");return t.type=e.type||"",t.id=e.id||"",t.placeholder=e.placeholder||"",void 0!==e.styles&&e.styles.forEach((e=>{t.classList.add(e)})),void 0!==e.dataset&&(t.dataset[e.dataset.key]=e.dataset.value),t}function n(e){const t=document.createElement("form");return t.acceptCharset=e.acceptCharset||"",t.action=e.action||"",t.autocomplete=e.autocomplete?"on":"off",t.enctype=e.enctype||"",t.method=e.method||"",t.name=e.name||"",t.noValidate=!!e.novalidate,t.target=e.target||"",t.id=e.id||"",void 0!==e.styles&&e.styles.forEach((e=>{t.classList.add(e)})),t}const o={title:"Добро пожаловать!",fields:[{title:"E-mail:",type:"email",id:"email-input",dataset:{key:"model_field",value:"email"},placeholder:"George@domain.com"},{title:"Пароль:",type:"password",id:"password-input",dataset:{key:"model_field",value:"password"},placeholder:"*****"}],submit:{id:"signin-submit-btn",text:"Войти"},footer:[{href:"/signup",id:"link-signup",text:"Нет аккаунта?"}]};function d(e,t){if(void 0!==e&&void 0!==t)switch(e){case"first_name":return/^[a-zа-я]{1,10}$/dgi.test(t)?{isValid:!0,msgError:""}:{isValid:!1,msgError:"Имя может состоять из русских и английских букв в одно слово"};case"last_name":return/^[a-zа-я]{1,10}$/dgi.test(t)?{isValid:!0,msgError:""}:{isValid:!1,msgError:"Фамилия может состоять из русских и английских букв в одно слово"};case"nick_name":return/^[\w]{1,10}$/dgi.test(t)?{isValid:!0,msgError:""}:{isValid:!1,msgError:"Псевдоним может состоять из английских букв и цифр без пробелов"};case"email":return/[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/gi.test(t)?{isValid:!0,msgError:""}:{isValid:!1,msgError:"Введённый email имеет некорректный вид"};case"password":return/^(\S*){8,}$/dgi.test(t)?{isValid:!0,msgError:""}:{isValid:!1,msgError:"Минимальная длина пароля 8 символов без пробелов"};case"repeat_password":return{isValid:!0,msgError:""}}return{isValid:!0,msgError:"ОШибка!!!!!"}}class a extends e{constructor(e){super(e),this.form=this.createForm()}render(){this.parent.appendChild(this.form)}createForm(){const e=n({id:"signin-form",styles:["form"]}),d=t({text:o.title,styles:["form__title"]}),a=t({styles:["form__content"]});o.fields.forEach((e=>{const i=t({text:e.title,styles:["form__input__title"]}),s=r({type:e.type,id:e.id,placeholder:e.placeholder,dataset:e.dataset,styles:["form__input"]}),n=t({styles:["form__input__error__msg"]}),o=t({styles:["groupbox"]});o.appendChild(i),o.appendChild(s),o.appendChild(n),a.appendChild(o)}));const l=i({id:o.submit.id,text:o.submit.text,styles:["form__button"]}),h=t({styles:["wrapper"]}),c=t({styles:["form__footer"]});return o.footer.forEach((e=>{c.appendChild(s({id:e.id,text:e.text,href:e.href,styles:["form__footer__link"]}))})),h.appendChild(c),e.appendChild(d),e.appendChild(a),e.appendChild(l),e.appendChild(h),e}bindRedirect(e){o.footer.forEach((t=>{const i=this.form.querySelector("#"+t.id);null!==i&&i.addEventListener("click",(i=>{i.preventDefault(),e(t.href)}))}))}bindSubmitForm(e){const t=this.form.querySelector("#"+o.submit.id);null!==t&&t.addEventListener("click",(t=>{t.preventDefault();const{data:i,isCorrect:s}=this.getData();s&&e(i)}))}getData(){const e=new Map;let t=!0;return o.fields.forEach((i=>{var s,r;const n=this.form.querySelector("#"+i.id);if(null===n)return void(t=!1);e.set(n.dataset.model_field,n.value),n.classList.remove("form__input__error"),(null===(s=n.parentElement)||void 0===s?void 0:s.querySelector(".form__input__error__msg")).style.visibility="hidden";const o=d(n.dataset.model_field,n.value);if(!o.isValid&&"password"!=n.dataset.model_field){t=!1,n.classList.add("form__input__error");const e=null===(r=n.parentElement)||void 0===r?void 0:r.querySelector(".form__input__error__msg");e.style.visibility="visible",e.textContent=o.msgError}})),{data:e,isCorrect:t}}showErrorInvalidPassword(){var e;const t=this.form.querySelector("#password-input");if(null===t)return;const i=null===(e=t.parentElement)||void 0===e?void 0:e.querySelector(".form__input__error__msg");i.style.visibility="visible",i.textContent="Неверный пароль"}showErrorNoSuchUser(){var e;const t=this.form.querySelector("#email-input");if(null===t)return;const i=null===(e=t.parentElement)||void 0===e?void 0:e.querySelector(".form__input__error__msg");i.style.visibility="visible",i.textContent="Неверный email или пароль"}}const l={title:"Рады вас приветствовать!",fields:[{title:"Ваше имя:",type:"text",id:"fist-name-input",placeholder:"Георгий",dataset:{key:"model_field",value:"first_name"}},{title:"Ваша фамилия:",type:"text",id:"last-name-input",placeholder:"Пупкин",dataset:{key:"model_field",value:"last_name"}},{title:"Придумайте псевдоним:",type:"text",id:"nickname-input",placeholder:"GeorgePupkin123",dataset:{key:"model_field",value:"nick_name"}},{title:"E-mail:",type:"email",id:"email-input",placeholder:"George@domain.com",dataset:{key:"model_field",value:"email"}},{title:"Пароль:",type:"password",id:"password-input",placeholder:"*****",dataset:{key:"model_field",value:"password"}},{title:"Введите пароль ещё раз:",type:"password",id:"repeat-password-input",placeholder:"*****",dataset:{key:"model_field",value:"repeat_password"}}],submit:{id:"signup-submit-btn",text:"Зарегистрироваться"},footer:[{href:"/signin",id:"link-signin",text:"Уже есть аккаунт?"}]};class h extends e{constructor(e){super(e),this.form=this.createForm()}render(){this.parent.appendChild(this.form)}createForm(){const e=n({id:"signup-form",styles:["form"]}),o=t({text:l.title,styles:["form__title"]}),d=t({});l.fields.forEach((e=>{const i=t({text:e.title,styles:["form__input__title"]}),s=r({type:e.type,id:e.id,placeholder:e.placeholder,styles:["form__input"],dataset:e.dataset}),n=t({styles:["form__input__error__msg"]}),o=t({styles:["groupbox"]});o.appendChild(i),o.appendChild(s),o.appendChild(n),d.appendChild(o)}));const a=i({id:l.submit.id,text:l.submit.text,styles:["form__button"]}),h=t({styles:["wrapper"]}),c=t({styles:["form__footer"]});return l.footer.forEach((e=>{c.appendChild(s({id:e.id,text:e.text,href:e.href,styles:["form__footer__link"]}))})),h.appendChild(c),e.appendChild(o),e.appendChild(d),e.appendChild(a),e.appendChild(h),e}bindSubmitForm(e){const t=this.form.querySelector("#"+l.submit.id);null!==t&&t.addEventListener("click",(t=>{t.preventDefault();const{data:i,isCorrect:s}=this.getData();s&&e(i)}))}bindRedirect(e){l.footer.forEach((t=>{const i=this.form.querySelector("#"+t.id);null!==i&&i.addEventListener("click",(i=>{i.preventDefault(),e(t.href)}))}))}getData(){var e;const t=new Map;let i=!0;if(l.fields.forEach((e=>{var s;const r=this.form.querySelector("#"+e.id);if(null===r)return void(i=!1);t.set(r.dataset.model_field,r.value),r.classList.remove("form__input__error");const n=null===(s=r.parentElement)||void 0===s?void 0:s.querySelector(".form__input__error__msg");n.style.visibility="hidden";const o=d(r.dataset.model_field,r.value);o.isValid||(i=!1,r.classList.add("form__input__error"),n.style.visibility="visible",n.textContent=o.msgError)})),!t.has("repeat_password")||!t.has("repeat_password")||t.get("repeat_password")!==t.get("password")){i=!1;const t=this.form.querySelector("#repeat-password-input");if(null!==t){t.classList.add("form__input__error");const i=null===(e=t.parentElement)||void 0===e?void 0:e.querySelector(".form__input__error__msg");i.style.display="visible",i.textContent="Пароли не совпадают"}}return{data:t,isCorrect:i}}showErrorUserExists(){var e;const t=this.form.querySelector("#email-input");if(null===t)return;const i=null===(e=t.parentElement)||void 0===e?void 0:e.querySelector(".form__input__error__msg");i.style.visibility="visible",i.textContent="Пользователь с таким именем уже существует"}}function c(e){const t=document.createElement("img");return t.id=e.id||"",t.src=e.src||"",void 0!==e.styles&&e.styles.forEach((e=>{t.classList.add(e)})),t}class p extends e{constructor(e){super(e)}render(){const e=t({styles:["footer"]}),i=t({styles:["footer__container"]}),r=c({src:"../src/img/footer_logo.png",styles:["footer__logo"]}),n=t({text:"Contacts:",styles:["contacts"]}),o=s({event:{eventType:"click",callback:e=>{}},href:"tel:555-555-5555",styles:["contacts__item"]}),d=c({src:"../src/img/phone_icon.svg",styles:["contacts__item__icon"]});o.appendChild(d),n.appendChild(o);const a=t({text:"TikTikAndVProd2022",styles:["company-name"]});i.appendChild(r),i.appendChild(n),i.appendChild(a),e.appendChild(i),this.parent.appendChild(e)}hide(){const e=this.parent.querySelector(".footer");void 0!==e&&(e.style.visibility="hidden")}show(){const e=this.parent.querySelector(".footer");void 0!==e&&(e.style.display="visible")}}const u="/signin",m="/signup",_="/feed",y="/menu",f="/profile",g=new class{constructor(){this.routes=[],this.current=void 0}addPath(e){this.routes.push(e)}goToPath(e){const t=this.routes.find((t=>t.path==e));void 0!==t&&t.handler()}},v={feed:{href:"/feed",name:"Лента",style:"",id:"menu__item_0"},profile:{href:"/profile",name:"Профиль",style:"",id:"menu__item_1"},logout:{href:"/logout",name:"Выйти",style:"menu__logout__link",id:"menu__item_2"}},w="http://localhost:8080";class b extends e{constructor(e){super(e)}changeActiveLink(e){var t,i;null===(t=document.getElementById(`menu__item_${this.activeLinkId}`))||void 0===t||t.classList.remove("menu__active__link"),this.activeLinkId=e,null===(i=document.getElementById(`menu__item_${this.activeLinkId}`))||void 0===i||i.classList.add("menu__active__link")}render(){const e=t({styles:["aside"]});Object.entries(v).map((([e,{href:t,name:i,style:r}],n)=>{const o=s({id:"menu__item_"+String(n),href:t,text:i,styles:["menu__item",r]});return o.dataset.section=e,0===n&&(o.classList.add("menu__active__link"),this.activeLinkId=n),o})).forEach((t=>{e.appendChild(t)})),this.parent.appendChild(e)}}class C{constructor(e){this.parent=e}render(e){const i=t({styles:["feed"]});e.forEach((e=>{const s=t({styles:["feed__element"]}),r=t({styles:["feed__author"]});r.appendChild(t({styles:["feed__author__photo"]})),r.appendChild(t({styles:["feed__author__name"],text:e.author_name}));const n=t({styles:["feed__date"],text:e.date.toString()}),o=t({styles:["feed__photo__wrapper"]});o.innerHTML='<img class=feed__photo__img src="../src/img/img-worlds-of-adventure.jpg"/><div';const d=t({styles:["feed__description"],text:e.description}),a=t({styles:["feed__bottom"]}),l=t({styles:["feed__bottom__likes"],text:`Likes · ${e.likes}`});a.appendChild(l),s.appendChild(r),s.appendChild(n),s.appendChild(d),s.appendChild(o),s.appendChild(a),i.appendChild(s)})),this.parent.appendChild(i)}}class E{constructor(e,t){this.view=e,this.model=t}}class k extends E{constructor(e,t){super(e,t),this.view.bindSubmitForm(this.submitSigninForm.bind(this)),this.view.bindRedirect(this.redirect.bind(this))}submitSigninForm(e){const t={email:e.get("email")||"",password:e.get("password")||""};this.model.authUser(t).then((({status:e,body:t})=>{g.goToPath(y),g.goToPath(_)})).catch((({status:e,body:t})=>{switch(e){case 401:this.view.showErrorInvalidPassword();break;case 404:this.view.showErrorNoSuchUser()}}))}redirect(e){g.goToPath(e)}}class x extends E{constructor(e,t){super(e,t),this.view.bindSubmitForm(this.submitSignupForm.bind(this)),this.view.bindRedirect(this.redirect.bind(this))}submitSignupForm(e){const t={first_name:e.get("first_name")||"",last_name:e.get("last_name")||"",nick_name:e.get("nick_name")||"",email:e.get("email")||"",password:e.get("password")||""};this.model.registerUser(t).then((({status:e,body:t})=>{g.goToPath(y),g.goToPath(_)})).catch((({status:e,body:t})=>{409===e&&this.view.showErrorUserExists()}))}redirect(e){g.goToPath(e)}}const P=new class{async asyncFetch(e){const t=await fetch(e.url,{method:e.method,body:e.body,credentials:"include"}),i=await t.json();return{status:t.status,parsedBody:i}}async get(e){return await this.asyncFetch({url:e,method:"GET"})}async post(e,t){return await this.asyncFetch({url:e,method:"POST",body:t})}async put(e,t){return await this.asyncFetch({url:e,method:"PUT",body:t})}async getTest(e){return Promise.reject({status:400,parsedBody:"none"})}};class S{constructor(e){this.view=e,this.view.getParent().addEventListener("click",this.clickHandler.bind(this))}clickHandler(e){e.preventDefault();const t=e.target;if(null!==t){if(t.id===v.feed.id)return this.view.changeActiveLink(0),void g.goToPath(_);if(t.id===v.profile.id)return this.view.changeActiveLink(1),void g.goToPath(f);if(t.id===v.logout.id)return P.get(`${w}/logout`),void g.goToPath(u)}}}class T{constructor(){}}class V extends T{constructor(){super(),this.currentUser=null}async authUser(e){const t=await P.post(`${w}/signin`,JSON.stringify(e));return this.currentUser={first_name:t.parsedBody.body.first_name,last_name:t.parsedBody.body.last_name,nick_name:t.parsedBody.body.nick_name,email:t.parsedBody.body.email,id:t.parsedBody.body.id},200===t.status?Promise.resolve({status:t.status,body:t.parsedBody}):Promise.reject({status:t.status,body:t.parsedBody})}async registerUser(e){const t=await P.post(`${w}/signup`,JSON.stringify(e));return this.currentUser={first_name:t.parsedBody.body.first_name,last_name:t.parsedBody.body.last_name,nick_name:t.parsedBody.body.nick_name,email:t.parsedBody.body.email,id:t.parsedBody.body.id},201===t.status?Promise.resolve({status:t.status,body:t.parsedBody}):Promise.reject({status:t.status,body:t.parsedBody})}getCurrentUser(){return this.currentUser}async isAuthantificated(){const e=await P.get(`${w}/auth`);return this.currentUser={first_name:e.parsedBody.body.first_name,last_name:e.parsedBody.body.last_name,nick_name:e.parsedBody.body.nick_name,email:e.parsedBody.body.email,id:e.parsedBody.body.id},200===e.status?Promise.resolve({status:e.status,body:e.parsedBody}):Promise.reject({status:e.status,body:e.parsedBody})}}class L extends T{constructor(){super()}async getFeeds(){const e=await P.get(`${w}/feed`);let t=e.status,i=e.parsedBody.body.map((e=>({photoLinks:e.image_links,description:e.description,likes:228,date:`${new Date(e.create_date).toJSON().slice(0,10).replace(/-/g,"/")}`,author_name:e.user_first_name,author_photo:""})));return 200===e.status?Promise.resolve({status:t,body:i}):Promise.reject({status:t,body:i})}}class B extends e{constructor(e){super(e)}render(){const e=document.createElement("div"),t=document.createElement("div");e.appendChild(t),t.innerText="PROFILE WILL BE APPEND IN THE NEXT UPDATES!",this.parent.appendChild(e)}}(new class{constructor(){this.initPage(),this.initModels(),this.initViews(),this.initControllers(),this.initRouter()}run(){this.footerView.render(),this.headerView.render(),this.userModel.isAuthantificated().then((({status:e,body:t})=>{g.goToPath(y),g.goToPath(_)})).catch((({status:e,body:t})=>{g.goToPath(u)}))}handleRedirectToSignin(){this.menu.innerHTML="",this.main.innerHTML="",this.headerView.setSignupButton(),this.headerView.show(),this.footerView.show(),this.signinView.render()}handleRedirectToSignup(){this.menu.innerHTML="",this.main.innerHTML="",this.headerView.setSigninButton(),this.headerView.show(),this.footerView.show(),this.signupView.render()}handleRedirectMenu(){this.menu.innerHTML="",this.menuView.render()}handleRedirectToFeedPage(){this.main.innerHTML="",this.headerView.show(),this.footerView.hide(),this.headerView.setProfile(this.userModel.getCurrentUser()),this.feedModel.getFeeds().then((({status:e,body:t})=>{this.feedView.render(t)})).catch((({status:e,body:t})=>{g.goToPath(u)}))}handleRedirectProfile(){this.main.innerHTML="",this.headerView.show(),this.footerView.hide(),this.profileView.render()}initPage(){this.root=t({id:"root"}),this.header=t({id:"header"}),this.content=t({id:"content"}),this.menu=t({id:"menu"}),this.main=t({id:"main"}),this.footer=t({id:"footer"}),this.root.appendChild(this.header),this.root.appendChild(this.content),this.content.appendChild(this.menu),this.content.appendChild(this.main),this.root.appendChild(this.footer),document.body.appendChild(this.root)}initViews(){this.signinView=new a(this.main),this.signupView=new h(this.main),this.footerView=new p(this.footer),this.headerView=new class{constructor(e){this.parent=e}render(){const e=t({styles:["header"]}),i=s({text:"WS",styles:["header__logo"]});e.appendChild(i),this.link=t({id:"header__item",styles:["header__item"],text:""}),e.appendChild(this.link),this.parent.appendChild(e)}hide(){const e=this.parent.querySelector(".header");void 0!==e&&(e.style.display="none")}show(){const e=this.parent.querySelector(".header");void 0!==e&&(e.style.display="visible")}setSignupButton(){this.link.innerHTML="",this.renderButtonItem("Зарегистрироваться",m)}setSigninButton(){this.link.innerHTML="",this.renderButtonItem("Войти",u)}setProfile(e){null!==e&&(this.link.innerHTML="",this.renderProfileItem(e))}renderProfileItem(e){const t=s({event:{eventType:"click",callback:()=>{g.goToPath(f)}},styles:["header__profile"]}),i=c({src:"../src/img/avatar_pavel.jpg",styles:["header__profile__avatar"]}),r=function(e){const t=document.createElement("text");return t.textContent=e.text||"",void 0!==e.styles&&e.styles.forEach((e=>{t.classList.add(e)})),t}({text:e.first_name,styles:["header__profile__name"]});t.appendChild(i),t.appendChild(r);const n=s({href:f,styles:["header__profile__settings"]}),o=c({src:"../src/img/settings_icon.svg",styles:["header__profile__settings__icon"]});n.appendChild(o),this.link.appendChild(t),this.link.appendChild(n)}renderButtonItem(e,t){this.link.appendChild(i({id:"header__link__profile",text:e,styles:["header_button"],event:{eventType:"click",callback:e=>{e.preventDefault(),g.goToPath(t)}}}))}}(this.header),this.menuView=new b(this.menu),this.feedView=new C(this.main),this.profileView=new B(this.main)}initModels(){this.userModel=new V,this.feedModel=new L}initControllers(){this.signinController=new k(this.signinView,this.userModel),this.signupController=new x(this.signupView,this.userModel),this.menuController=new S(this.menuView)}initRouter(){g.addPath({path:u,handler:this.handleRedirectToSignin.bind(this)}),g.addPath({path:m,handler:this.handleRedirectToSignup.bind(this)}),g.addPath({path:_,handler:this.handleRedirectToFeedPage.bind(this)}),g.addPath({path:f,handler:this.handleRedirectProfile.bind(this)}),g.addPath({path:y,handler:this.handleRedirectMenu.bind(this)})}}).run()})();